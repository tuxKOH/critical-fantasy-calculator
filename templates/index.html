<!DOCTYPE html>
<!--
Critical Fantasy Damage Calculator
Copyright (C) 2024  @tux_koh

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Critical Fantasy Damage Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .calculator {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .panel-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .panel-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .attribute-points {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .point-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .point-input label {
            flex: 1;
            margin-bottom: 0;
        }
        
        .point-input input {
            width: 80px;
        }
        
        .equipment-search {
            margin-bottom: 15px;
        }
        
        .equipment-tiers {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .tier-filter {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tier-filter.active {
            background: #667eea;
            color: white;
        }
        
        .equipment-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }
        
        .equipment-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .equipment-item:hover {
            background: #f8f9fa;
        }
        
        .equipment-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .equipment-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .equipment-tier {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .equipment-stats {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .equipment-effects {
            font-size: 0.85em;
            color: #888;
            font-style: italic;
        }
        
        .selected-equipment {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .selected-item {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .remove-item {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .potion-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .potion-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .potion-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .potion-info {
            flex: 1;
        }
        
        .potion-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .potion-desc {
            font-size: 0.85em;
            color: #666;
        }
        
        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
        }
        
        .result {
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .result h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .result-label {
            font-weight: bold;
            color: #666;
        }
        
        .result-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .result-highlight {
            color: #667eea;
            font-size: 1.1em;
        }
        
        .player-stats {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        
        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #856404;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            color: #666;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #f5b7b1;
        }
        
        .flame-set-indicator {
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .wolf-set-indicator {
            background: #8e44ad;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .crimson-set-indicator {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .queen-bee-set-indicator {
            background: #ffc107;
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .explorer-set-indicator {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .forest-set-indicator {
            background: #20c997;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .library-set-indicator {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .blessing-set-indicator {
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .system-toggle {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .toggle-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-option.active {
            background: #667eea;
            color: white;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .weapon-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Critical Fantasy Damage Calculator</h1>
            <p>Calculate your ideal damage with equipment combinations and attribute points</p>
        </div>
        
        <div class="calculator">
            <div class="left-panel">
                <!-- Input System Toggle -->
                <div class="panel-section">
                    <h3>Input System</h3>
                    <div class="system-toggle">
                        <div class="toggle-option active" id="togglePoints" onclick="toggleInputSystem('points')">
                            Attribute Points (Level 190)
                        </div>
                        <div class="toggle-option" id="toggleManual" onclick="toggleInputSystem('manual')">
                            Manual Input
                        </div>
                    </div>
                </div>

                <!-- Weapon Selection -->
                <div class="panel-section">
                    <h3>Weapon Selection</h3>
                    <div class="form-group">
                        <select id="weaponSelect" onchange="updateWeaponInfo(); calculateDamage();">
                            <option value="">No Weapon</option>
                            <option value="wooden_sword">Wooden Sword (Physical)</option>
                            <option value="wooden_staff">Wooden Staff (Magic)</option>
                            <option value="wooden_bow">Wooden Bow (Physical)</option>
                            <option value="divine_blade">Divine Blade (Physical)</option>
                            <option value="forest_dweller_staff">Forest Dweller's Staff (Magic)</option>
                            <option value="forest_dweller_bow">Forest Dweller's Bow (Physical)</option>
                            <option value="crescendo_scythe">Crescendo Scythe (Physical)</option>
                            <option value="emerald_staff">Emerald Staff (Magic)</option>
                            <option value="winter_howl">Winter Howl (Physical)</option>
                            <option value="eventide">Eventide (Physical)</option>
                        </select>
                    </div>
                    <div id="weaponInfo" class="weapon-info">
                        No weapon selected
                    </div>
                </div>
                
                <!-- Attribute Points Section -->
                <div class="panel-section" id="pointsSection">
                    <h3>Attribute Points <span class="tooltip">(?)
                        <span class="tooltiptext">
                            Strength: +2.96 Min Damage, +6.45 Max Damage per point<br>
                            Vitality: +35 HP per point<br>
                            Intelligence: +6 Magic Damage per point<br>
                            Dexterity: +0.8% Crit Chance per point (max 50 points = 40%)<br>
                            Defense: +17 Shield per point<br>
                            Base Crit Rate: 1%<br>
                            Base Crit Damage: 100%
                        </span>
                    </span></h3>
                    <div class="attribute-points">
                        <div class="point-input">
                            <label for="strength">Strength:</label>
                            <input type="number" id="strength" min="0" max="380" value="0" onchange="updatePoints()">
                        </div>
                        <div class="point-input">
                            <label for="vitality">Vitality:</label>
                            <input type="number" id="vitality" min="0" max="380" value="0" onchange="updatePoints()">
                        </div>
                        <div class="point-input">
                            <label for="intelligence">Intelligence:</label>
                            <input type="number" id="intelligence" min="0" max="380" value="0" onchange="updatePoints()">
                        </div>
                        <div class="point-input">
                            <label for="dexterity">Dexterity:</label>
                            <input type="number" id="dexterity" min="0" max="50" value="0" onchange="updatePoints()">
                        </div>
                        <div class="point-input">
                            <label for="defense">Defense:</label>
                            <input type="number" id="defense" min="0" max="380" value="0" onchange="updatePoints()">
                        </div>
                    </div>
                    <div class="points-info">
                        <p>Total Points Used: <span id="totalPoints">0</span> / 380</p>
                        <p>Points Remaining: <span id="remainingPoints">380</span></p>
                        <p style="font-size: 0.9em; color: #666;">Dexterity capped at 50 points (40% crit)</p>
                    </div>
                </div>
                
                <!-- Manual Input Section -->
                <div class="panel-section" id="manualSection" style="display: none;">
                    <h3>Manual Stats Input</h3>
                    <div class="stats-grid">
                        <div class="form-group">
                            <label for="minDamage">Min Attack Damage:</label>
                            <input type="number" id="minDamage" placeholder="Enter min damage" min="0" step="1" onchange="calculateDamage()">
                        </div>
                        <div class="form-group">
                            <label for="maxDamage">Max Attack Damage:</label>
                            <input type="number" id="maxDamage" placeholder="Enter max damage" min="0" step="1" onchange="calculateDamage()">
                        </div>
                        <div class="form-group">
                            <label for="magicDamage">Magic Damage:</label>
                            <input type="number" id="magicDamage" placeholder="Enter magic damage" min="0" step="1" onchange="calculateDamage()">
                        </div>
                    </div>
                </div>
                
                <!-- Combat Stats -->
                <div class="panel-section">
                    <h3>Combat Stats</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Crit Stats are automatically calculated:<br>
                        - Base: 1% Crit Rate, 100% Crit Damage<br>
                        - Dexterity: +0.8% Crit Rate per point<br>
                        - Weapons and Equipment provide additional bonuses
                    </p>
                </div>
                
                <!-- Equipment Selection -->
                <div class="panel-section">
                    <h3>Equipment Selection (Max 3)</h3>
                    <div class="equipment-search">
                        <input type="text" id="equipmentSearch" placeholder="Search equipment..." oninput="filterEquipment()">
                    </div>
                    <div class="equipment-tiers">
                        <button class="tier-filter active" onclick="filterByTier('all')">All</button>
                        <button class="tier-filter" onclick="filterByTier('I')">Tier I</button>
                        <button class="tier-filter" onclick="filterByTier('II')">Tier II</button>
                        <button class="tier-filter" onclick="filterByTier('III')">Tier III</button>
                        <button class="tier-filter" onclick="filterByTier('IV')">Tier IV</button>
                        <button class="tier-filter" onclick="filterByTier('V')">Tier V</button>
                    </div>
                    <div class="equipment-list" id="equipmentList">
                        <!-- Equipment items will be populated by JavaScript -->
                    </div>
                    <div class="selected-equipment" id="selectedEquipment">
                        <!-- Selected equipment will appear here -->
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <!-- Potion Effects -->
                <div class="panel-section">
                    <h3>Potion Effects</h3>
                    <div class="potion-grid">
                        <div class="potion-item">
                            <input type="checkbox" id="magicPotion" onchange="calculateDamage()">
                            <div class="potion-info">
                                <div class="potion-name">Magic Potion</div>
                                <div class="potion-desc">1.75x Magic Damage</div>
                            </div>
                        </div>
                        <div class="potion-item">
                            <input type="checkbox" id="attackPotion" onchange="calculateDamage()">
                            <div class="potion-info">
                                <div class="potion-name">Attack Potion</div>
                                <div class="potion-desc">1.75x Attack Damage</div>
                            </div>
                        </div>
                        <div class="potion-item">
                            <input type="checkbox" id="goldenApple" onchange="calculateDamage()">
                            <div class="potion-info">
                                <div class="potion-name">Golden Apple</div>
                                <div class="potion-desc">1.5x Attack Damage (does not stack with Attack Potion)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Player Stats -->
                <div class="panel-section player-stats" id="playerStatsSection" style="display: none;">
                    <h3>Player Stats</h3>
                    <div id="playerStatsContent">
                        <!-- Player stats will be populated here -->
                    </div>
                </div>
                
                <!-- Results -->
                <div class="panel-section result" id="resultSection" style="display: none;">
                    <h3>Calculation Results</h3>
                    <div class="result-grid">
                        <div>
                            <div class="result-item">
                                <span class="result-label">Original Physical Range:</span>
                                <span class="result-value" id="resultOriginalRange">0 - 0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Original Average Physical:</span>
                                <span class="result-value" id="resultAvgPhysical">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Original Magic Damage:</span>
                                <span class="result-value" id="resultMagic">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Effective Physical Range:</span>
                                <span class="result-value" id="resultEffectiveRange">0 - 0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Effective Average Physical:</span>
                                <span class="result-value" id="resultEffectiveAvgPhysical">0</span>
                            </div>
                        </div>
                        <div>
                            <div class="result-item">
                                <span class="result-label">Effective Magic Damage:</span>
                                <span class="result-value" id="resultEffectiveMagic">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Base Damage (Selected Type):</span>
                                <span class="result-value" id="resultBaseDamage">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Crit Multiplied Damage:</span>
                                <span class="result-value" id="resultCrit">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">DoT Damage:</span>
                                <span class="result-value" id="resultDot">0</span>
                            </div>
                            <div class="result-item" style="border-bottom: none;">
                                <span class="result-label result-highlight">Final Damage:</span>
                                <span class="result-value result-highlight" id="resultFinal">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Effective Multiplier:</span>
                        <span class="result-value" id="resultMultiplier">0x</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Crit Rate:</span>
                        <span class="result-value" id="resultCritRate">0%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Crit Damage:</span>
                        <span class="result-value" id="resultCritDamage">0%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Damage Type:</span>
                        <span class="result-value" id="resultDamageType">Physical</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Burn Chance:</span>
                        <span class="result-value" id="resultBurnChance">0%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Bleed Chance:</span>
                        <span class="result-value" id="resultBleedChance">0%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Poison Chance:</span>
                        <span class="result-value" id="resultPoisonChance">0%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Flame Set Items:</span>
                        <span class="result-value" id="resultFlameSet">0</span>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateDamage()">Calculate Damage</button>
                
                <div class="note">
                    <strong>Note:</strong> DoT damage is calculated separately and is not affected by crit or equipment damage multipliers. Flame Set bonus (+10% burn chance) is applied when having 2+ flame set items. Damage type is automatically determined by weapon selection (Staff = Magic, Others = Physical). Crit stats are automatically calculated from base values, dexterity, weapons, and equipment.
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>made by <strong>@tux_koh</strong></p>
            <p><a href="https://www.roblox.com/game-pass/1540670718/donation" target="_blank">donate me 10 bobux :D</a></p>
        </div>
    </div>

    <script>
        // Global variables
        let selectedEquipment = [];
        const maxEquipment = 3;
        let equipmentDatabase = {{ equipment_db | tojson | safe }};
        let weaponDatabase = {{ weapon_db | tojson | safe }};
        let currentTierFilter = 'all';
        let currentSearchFilter = '';
        
        // Set indicator mapping
        const setIndicators = {
            'flame': { class: 'flame-set-indicator', text: 'Flame Set' },
            'wolf_howl': { class: 'wolf-set-indicator', text: 'Wolf Set' },
            'crimson': { class: 'crimson-set-indicator', text: 'Crimson Set' },
            'queen_bee': { class: 'queen-bee-set-indicator', text: 'Queen Bee Set' },
            'explorer': { class: 'explorer-set-indicator', text: 'Explorer Set' },
            'forest_dweller': { class: 'forest-set-indicator', text: 'Forest Set' },
            'library_ruina': { class: 'library-set-indicator', text: 'Library Set' },
            'blessing': { class: 'blessing-set-indicator', text: 'Blessing Set' }
        };
        
        // Initialize equipment list
        function initializeEquipment() {
            const equipmentList = document.getElementById('equipmentList');
            equipmentList.innerHTML = '';
            
            Object.entries(equipmentDatabase).forEach(([id, data]) => {
                if (filterEquipmentItem(id, data)) {
                    const item = createEquipmentItem(id, data);
                    equipmentList.appendChild(item);
                }
            });
        }
        
        // Create equipment item element
        function createEquipmentItem(id, data) {
            const div = document.createElement('div');
            div.className = 'equipment-item';
            div.setAttribute('data-id', id);
            div.setAttribute('data-tier', data.tier);
            
            // Build stats string
            const stats = [];
            if (data.stats.atk_min !== undefined && data.stats.atk_max !== undefined) {
                stats.push(`ATK: ${data.stats.atk_min}-${data.stats.atk_max}`);
            } else if (data.stats.atk_min !== undefined) {
                stats.push(`ATK: ${data.stats.atk_min}`);
            }
            if (data.stats.magic !== undefined) {
                stats.push(`Magic: ${data.stats.magic}`);
            }
            if (data.stats.crit_chance !== undefined) {
                stats.push(`Crit: +${data.stats.crit_chance}%`);
            }
            if (data.stats.crit_damage !== undefined) {
                stats.push(`Crit DMG: +${data.stats.crit_damage}%`);
            }
            if (data.stats.health !== undefined) {
                stats.push(`HP: +${data.stats.health}`);
            }
            if (data.stats.shield !== undefined) {
                stats.push(`Shield: +${data.stats.shield}`);
            }
            
            // Build effects string
            const effects = [];
            if (data.special_effects.damage_multiplier) {
                effects.push(`${data.special_effects.damage_multiplier}x Damage`);
            }
            if (data.special_effects.double_damage_chance) {
                effects.push(`${data.special_effects.double_damage_chance * 100}% 2x Damage`);
            }
            if (data.special_effects.burn_chance) {
                effects.push(`+${data.special_effects.burn_chance * 100}% Burn`);
            }
            if (data.special_effects.bleed_chance) {
                effects.push(`+${data.special_effects.bleed_chance * 100}% Bleed`);
            }
            if (data.special_effects.poison_chance) {
                effects.push(`+${data.special_effects.poison_chance * 100}% Poison`);
            }
            if (data.special_effects.blood_butcher) {
                effects.push('Blood Butcher Debuff');
            }
            if (data.special_effects.freeze_chance) {
                effects.push(`+${data.special_effects.freeze_chance * 100}% Freeze`);
            }
            if (data.special_effects.dot_bonus) {
                effects.push('+20% Magic to DoT');
            }
            
            let setIndicator = '';
            if (data.set && setIndicators[data.set]) {
                const setInfo = setIndicators[data.set];
                setIndicator = `<span class="${setInfo.class}">${setInfo.text}</span>`;
            }
            
            div.innerHTML = `
                <div class="equipment-header">
                    <div class="equipment-name">${data.name} ${setIndicator}</div>
                    <div class="equipment-tier">Tier ${data.tier}</div>
                </div>
                <div class="equipment-stats">${stats.join(', ')}</div>
                <div class="equipment-effects">${effects.join(', ')}</div>
            `;
            
            div.addEventListener('click', () => toggleEquipmentSelection(id, data));
            
            return div;
        }
        
        // Filter equipment based on search and tier
        function filterEquipmentItem(id, data) {
            const matchesSearch = data.name.toLowerCase().includes(currentSearchFilter.toLowerCase()) ||
                                id.toLowerCase().includes(currentSearchFilter.toLowerCase());
            const matchesTier = currentTierFilter === 'all' || data.tier === currentTierFilter;
            
            return matchesSearch && matchesTier;
        }
        
        // Filter equipment list
        function filterEquipment() {
            currentSearchFilter = document.getElementById('equipmentSearch').value;
            initializeEquipment();
        }
        
        // Filter by tier
        function filterByTier(tier) {
            currentTierFilter = tier;
            document.querySelectorAll('.tier-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            initializeEquipment();
        }
        
        // Toggle equipment selection
        function toggleEquipmentSelection(id, data) {
            if (selectedEquipment.includes(id)) {
                // Deselect
                selectedEquipment = selectedEquipment.filter(eq => eq !== id);
                document.querySelector(`.equipment-item[data-id="${id}"]`).classList.remove('selected');
            } else {
                // Select
                if (selectedEquipment.length < maxEquipment) {
                    selectedEquipment.push(id);
                    document.querySelector(`.equipment-item[data-id="${id}"]`).classList.add('selected');
                } else {
                    alert('You can only select up to 3 equipment items!');
                }
            }
            updateSelectedEquipmentDisplay();
            calculateDamage();
        }
        
        // Update selected equipment display
        function updateSelectedEquipmentDisplay() {
            const container = document.getElementById('selectedEquipment');
            container.innerHTML = '';
            
            selectedEquipment.forEach(id => {
                const data = equipmentDatabase[id];
                const div = document.createElement('div');
                div.className = 'selected-item';
                div.innerHTML = `
                    ${data.name}
                    <button class="remove-item" onclick="removeEquipment('${id}')">Ã—</button>
                `;
                container.appendChild(div);
            });
        }
        
        // Remove equipment
        function removeEquipment(id) {
            selectedEquipment = selectedEquipment.filter(eq => eq !== id);
            document.querySelector(`.equipment-item[data-id="${id}"]`).classList.remove('selected');
            updateSelectedEquipmentDisplay();
            calculateDamage();
        }
        
        // Weapon selection
        function updateWeaponInfo() {
            const weaponSelect = document.getElementById('weaponSelect');
            const weaponInfo = document.getElementById('weaponInfo');
            const selectedWeapon = weaponSelect.value;
            
            if (selectedWeapon && weaponDatabase[selectedWeapon]) {
                const weapon = weaponDatabase[selectedWeapon];
                const stats = [];
                
                if (weapon.stats.atk_min !== undefined && weapon.stats.atk_max !== undefined) {
                    stats.push(`ATK: ${weapon.stats.atk_min}-${weapon.stats.atk_max}`);
                } else if (weapon.stats.atk_min !== undefined) {
                    stats.push(`ATK: ${weapon.stats.atk_min}`);
                }
                if (weapon.stats.magic !== undefined) {
                    stats.push(`Magic: ${weapon.stats.magic}`);
                }
                if (weapon.stats.crit_chance !== undefined) {
                    stats.push(`Crit: +${weapon.stats.crit_chance}%`);
                }
                if (weapon.stats.crit_damage !== undefined) {
                    stats.push(`Crit DMG: +${weapon.stats.crit_damage}%`);
                }
                
                const damageType = weapon.type === 'staff' ? 'Magic' : 'Physical';
                
                let setInfo = '';
                if (weapon.set && setIndicators[weapon.set]) {
                    const setData = setIndicators[weapon.set];
                    setInfo = `<br><span class="${setData.class}">${setData.text}</span>`;
                }
                
                weaponInfo.innerHTML = `
                    <strong>${weapon.name}</strong> (${damageType})${setInfo}<br>
                    ${stats.join(', ')}
                `;
            } else {
                weaponInfo.innerHTML = 'No weapon selected';
            }
        }
        
        // Toggle input system
        function toggleInputSystem(system) {
            document.getElementById('togglePoints').classList.toggle('active', system === 'points');
            document.getElementById('toggleManual').classList.toggle('active', system === 'manual');
            document.getElementById('pointsSection').style.display = system === 'points' ? 'block' : 'none';
            document.getElementById('manualSection').style.display = system === 'manual' ? 'block' : 'none';
            
            // Update calculation
            calculateDamage();
        }
        
        // Update points calculation
        function updatePoints() {
            const strength = parseInt(document.getElementById('strength').value) || 0;
            const vitality = parseInt(document.getElementById('vitality').value) || 0;
            const intelligence = parseInt(document.getElementById('intelligence').value) || 0;
            const dexterity = parseInt(document.getElementById('dexterity').value) || 0;
            const defense = parseInt(document.getElementById('defense').value) || 0;
            
            const total = strength + vitality + intelligence + dexterity + defense;
            document.getElementById('totalPoints').textContent = total;
            document.getElementById('remainingPoints').textContent = 380 - total;
            
            calculateDamage();
        }
        
        // Main damage calculation function
        function calculateDamage() {
            const usePointSystem = document.getElementById('togglePoints').classList.contains('active');
            const selectedWeapon = document.getElementById('weaponSelect').value;
            
            const data = {
                usePointSystem: usePointSystem,
                selectedWeapon: selectedWeapon,
                equipment: selectedEquipment,
                magicPotion: document.getElementById('magicPotion').checked,
                attackPotion: document.getElementById('attackPotion').checked,
                goldenApple: document.getElementById('goldenApple').checked
            };
            
            if (usePointSystem) {
                data.strength = parseInt(document.getElementById('strength').value) || 0;
                data.vitality = parseInt(document.getElementById('vitality').value) || 0;
                data.intelligence = parseInt(document.getElementById('intelligence').value) || 0;
                data.dexterity = parseInt(document.getElementById('dexterity').value) || 0;
                data.defense = parseInt(document.getElementById('defense').value) || 0;
            } else {
                data.minDamage = document.getElementById('minDamage').value;
                data.maxDamage = document.getElementById('maxDamage').value;
                data.magicDamage = document.getElementById('magicDamage').value;
            }
            
            // Don't calculate if required fields are empty
            if (!usePointSystem && (!data.minDamage || !data.maxDamage || !data.magicDamage)) {
                return;
            }
            
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update results display
                    document.getElementById('resultOriginalRange').textContent = 
                        result.min_damage.toLocaleString() + ' - ' + result.max_damage.toLocaleString();
                    document.getElementById('resultAvgPhysical').textContent = result.avg_physical_damage.toLocaleString();
                    document.getElementById('resultMagic').textContent = result.magic_damage.toLocaleString();
                    document.getElementById('resultEffectiveRange').textContent = 
                        result.effective_min_damage.toLocaleString() + ' - ' + result.effective_max_damage.toLocaleString();
                    document.getElementById('resultEffectiveAvgPhysical').textContent = result.effective_avg_physical_damage.toLocaleString();
                    document.getElementById('resultEffectiveMagic').textContent = result.effective_magic_damage.toLocaleString();
                    document.getElementById('resultBaseDamage').textContent = result.base_damage.toLocaleString();
                    document.getElementById('resultCrit').textContent = result.crit_multiplied_damage.toLocaleString();
                    document.getElementById('resultDot').textContent = result.dot_damage.toLocaleString();
                    document.getElementById('resultFinal').textContent = result.final_damage.toLocaleString();
                    document.getElementById('resultMultiplier').textContent = result.effective_multiplier + 'x';
                    document.getElementById('resultCritRate').textContent = result.crit_rate.toLocaleString() + '%';
                    document.getElementById('resultCritDamage').textContent = result.crit_damage.toLocaleString() + '%';
                    document.getElementById('resultDamageType').textContent = result.damage_type === 'magic' ? 'Magic' : 'Physical';
                    document.getElementById('resultBurnChance').textContent = result.burn_chance + '%';
                    document.getElementById('resultBleedChance').textContent = result.bleed_chance + '%';
                    document.getElementById('resultPoisonChance').textContent = result.poison_chance + '%';
                    document.getElementById('resultFlameSet').textContent = result.flame_set_count;
                    
                    // Show player stats if using point system
                    if (result.calculated_stats && result.player_stats) {
                        document.getElementById('playerStatsSection').style.display = 'block';
                        
                        // Determine damage type for display
                        const damageTypeDisplay = result.damage_type === 'magic' ? 'Magic' : 'Physical';
                        
                        document.getElementById('playerStatsContent').innerHTML = `
                            <div class="result-item">
                                <span class="result-label">Health:</span>
                                <span class="result-value">${result.player_stats.health.toLocaleString()}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Shield:</span>
                                <span class="result-value">${result.player_stats.shield.toLocaleString()}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Total HP:</span>
                                <span class="result-value">${result.player_stats.total_hp.toLocaleString()}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Attack Range:</span>
                                <span class="result-value">${result.player_stats.min_damage.toLocaleString()} - ${result.player_stats.max_damage.toLocaleString()}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Magic Damage:</span>
                                <span class="result-value">${result.player_stats.magic_damage.toLocaleString()}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Crit Chance:</span>
                                <span class="result-value">${result.crit_rate.toLocaleString()}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Crit Damage:</span>
                                <span class="result-value">${result.crit_damage.toLocaleString()}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Damage Type:</span>
                                <span class="result-value">${damageTypeDisplay}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Burn Chance:</span>
                                <span class="result-value">${result.burn_chance}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Bleed Chance:</span>
                                <span class="result-value">${result.bleed_chance}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Poison Chance:</span>
                                <span class="result-value">${result.poison_chance}%</span>
                            </div>
                        `;
                    } else {
                        document.getElementById('playerStatsSection').style.display = 'none';
                    }
                    
                    document.getElementById('resultSection').style.display = 'block';
                } else {
                    console.error('Error:', result.error);
                }
            })
            .catch(error => {
                console.error('Error calculating damage:', error);
            });
        }
        
        // Auto-calculate when inputs change
        document.getElementById('minDamage')?.addEventListener('input', calculateDamage);
        document.getElementById('maxDamage')?.addEventListener('input', calculateDamage);
        document.getElementById('magicDamage')?.addEventListener('input', calculateDamage);
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeEquipment();
            updatePoints();
            updateWeaponInfo();
            calculateDamage();
        });
    </script>
</body>
</html>